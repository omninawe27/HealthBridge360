{% extends 'base.html' %}
{% load static %}
{% block title %}Set New Password{% endblock %}

{% block content %}
<div class="container-fluid min-vh-100 position-relative overflow-hidden pt-5" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);">
    <!-- Animated background elements -->
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 20% 80%, rgba(255, 154, 158, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(254, 207, 239, 0.3) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(255, 193, 193, 0.2) 0%, transparent 50%); animation: float 20s ease-in-out infinite;"></div>

    <div class="row justify-content-center align-items-center min-vh-100 w-100 position-relative">
        <div class="col-md-8 col-lg-6 col-xl-5">
            <!-- Main reset card -->
            <div class="card shadow-lg border-0 position-relative" style="border-radius: 25px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); transform: translateY(0); transition: all 0.3s ease; animation: slideUp 0.8s ease-out;">
                <!-- Decorative elements -->
                <div class="position-absolute top-0 end-0 p-3">
                    <div class="bg-gradient-success d-inline-flex align-items-center justify-content-center rounded-circle" style="width: 60px; height: 60px; transform: translate(20px, -20px); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-lock text-white fa-lg"></i>
                    </div>
                </div>

                <div class="card-body p-5">
                    <!-- Header section -->
                    <div class="text-center mb-4">
                        <div class="mb-4">
                            <div class="bg-gradient-success d-inline-flex align-items-center justify-content-center rounded-circle" style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);">
                                <i class="fas fa-lock text-white fa-2x"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold mb-2" style="color: #1e293b; font-size: 2rem;">Set New Password</h2>
                        <p class="text-muted mb-0" style="font-size: 1.1rem;">Create a strong password for your account</p>
                    </div>

                    <form method="post" id="passwordResetConfirmForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="{{ form.new_password1.id_for_label }}" class="form-label fw-semibold" style="color: #374151;">
                                <i class="fas fa-key me-2" style="color: #10b981;"></i>{{ form.new_password1.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" name="new_password1" class="form-control form-control-lg border-start-0" id="{{ form.new_password1.id_for_label }}" required style="border-left: none; box-shadow: none;">
                                <button class="btn btn-outline-secondary border-start-0" type="button" id="togglePassword1" style="border-left: none;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            {% if form.new_password1.errors %}
                                <div class="text-danger small mt-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ form.new_password1.errors.0 }}
                                </div>
                            {% endif %}
                            <!-- Password Strength Meter -->
                            <div id="passwordStrength" class="mt-2" style="display: none;">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%; transition: all 0.3s ease;"></div>
                                </div>
                                <small id="strengthText" class="text-muted mt-1 d-block"></small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.new_password2.id_for_label }}" class="form-label fw-semibold" style="color: #374151;">
                                <i class="fas fa-key me-2" style="color: #059669;"></i>{{ form.new_password2.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none;">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" name="new_password2" class="form-control form-control-lg border-start-0" id="{{ form.new_password2.id_for_label }}" required style="border-left: none; box-shadow: none;">
                                <button class="btn btn-outline-secondary border-start-0" type="button" id="togglePassword2" style="border-left: none;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            {% if form.new_password2.errors %}
                                <div class="text-danger small mt-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ form.new_password2.errors.0 }}
                                </div>
                            {% endif %}
                            <div id="passwordMatch" class="mt-2" style="display: none;"></div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-gradient-success btn-lg position-relative overflow-hidden" id="submitBtn" style="border: none; border-radius: 12px; padding: 12px 30px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease;">
                                <span class="position-relative z-index-1">
                                    <i class="fas fa-save me-2"></i>Change Password
                                </span>
                                <div class="position-absolute top-0 start-0 w-100 h-100 bg-white opacity-25 transform scale-x-0 transition-transform origin-left" id="btnOverlay"></div>
                            </button>
                        </div>
                    </form>

                    <!-- Password Requirements -->
                    <div class="mt-4 p-3 rounded" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h6 class="mb-2" style="color: #059669;">
                            <i class="fas fa-shield-alt me-2"></i>Password Requirements
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <small id="req-length" class="text-muted d-block">
                                    <i class="fas fa-times me-2"></i>At least 8 characters
                                </small>
                                <small id="req-uppercase" class="text-muted d-block">
                                    <i class="fas fa-times me-2"></i>One uppercase letter
                                </small>
                            </div>
                            <div class="col-6">
                                <small id="req-lowercase" class="text-muted d-block">
                                    <i class="fas fa-times me-2"></i>One lowercase letter
                                </small>
                                <small id="req-number" class="text-muted d-block">
                                    <i class="fas fa-times me-2"></i>One number
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Tips Card -->
            <div class="card mt-4 border-0" style="border-radius: 15px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);">
                <div class="card-body p-4">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-shield-alt fa-2x" style="color: #10b981;"></i>
                            </div>
                            <h6 class="mb-1" style="color: #374151; font-weight: 600;">Secure</h6>
                            <small class="text-muted">Your password is encrypted</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-user-secret fa-2x" style="color: #059669;"></i>
                            </div>
                            <h6 class="mb-1" style="color: #374151; font-weight: 600;">Private</h6>
                            <small class="text-muted">Never share your password</small>
                        </div>
                        <div class="col-4">
                            <div class="mb-2">
                                <i class="fas fa-key fa-2x" style="color: #047857;"></i>
                            </div>
                            <h6 class="mb-1" style="color: #374151; font-weight: 600;">Unique</h6>
                            <small class="text-muted">Use different passwords</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block footer %}{% endblock footer %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('passwordResetConfirmForm');
    const password1Field = document.querySelector('input[name="new_password1"]');
    const password2Field = document.querySelector('input[name="new_password2"]');
    const passwordMatch = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    const btnOverlay = document.getElementById('btnOverlay');
    const togglePassword1 = document.getElementById('togglePassword1');
    const togglePassword2 = document.getElementById('togglePassword2');

    // Password strength calculation
    function calculatePasswordStrength(password) {
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) {
            strength += 25;
            document.getElementById('req-length').className = 'text-success';
            document.getElementById('req-length').innerHTML = '<i class="fas fa-check me-2"></i>At least 8 characters';
        } else {
            document.getElementById('req-length').className = 'text-muted';
            document.getElementById('req-length').innerHTML = '<i class="fas fa-times me-2"></i>At least 8 characters';
        }

        if (/[A-Z]/.test(password)) {
            strength += 25;
            document.getElementById('req-uppercase').className = 'text-success';
            document.getElementById('req-uppercase').innerHTML = '<i class="fas fa-check me-2"></i>One uppercase letter';
        } else {
            document.getElementById('req-uppercase').className = 'text-muted';
            document.getElementById('req-uppercase').innerHTML = '<i class="fas fa-times me-2"></i>One uppercase letter';
        }

        if (/[a-z]/.test(password)) {
            strength += 25;
            document.getElementById('req-lowercase').className = 'text-success';
            document.getElementById('req-lowercase').innerHTML = '<i class="fas fa-check me-2"></i>One lowercase letter';
        } else {
            document.getElementById('req-lowercase').className = 'text-muted';
            document.getElementById('req-lowercase').innerHTML = '<i class="fas fa-times me-2"></i>One lowercase letter';
        }

        if (/[0-9]/.test(password)) {
            strength += 25;
            document.getElementById('req-number').className = 'text-success';
            document.getElementById('req-number').innerHTML = '<i class="fas fa-check me-2"></i>One number';
        } else {
            document.getElementById('req-number').className = 'text-muted';
            document.getElementById('req-number').innerHTML = '<i class="fas fa-times me-2"></i>One number';
        }

        return { strength, feedback };
    }

    // Update password strength meter
    function updatePasswordStrength() {
        const password = password1Field.value;
        const strengthContainer = document.getElementById('passwordStrength');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');

        if (password.length === 0) {
            strengthContainer.style.display = 'none';
            return;
        }

        strengthContainer.style.display = 'block';
        const { strength } = calculatePasswordStrength(password);

        strengthBar.style.width = strength + '%';

        if (strength < 25) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Very Weak';
            strengthText.className = 'text-danger mt-1 d-block';
        } else if (strength < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Weak';
            strengthText.className = 'text-info mt-1 d-block';
        } else if (strength < 75) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
            strengthText.className = 'text-info mt-1 d-block';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
            strengthText.className = 'text-success mt-1 d-block';
        }
    }

    // Check password match
    function checkPasswordMatch() {
        const password1 = password1Field.value;
        const password2 = password2Field.value;

        if (password2.length === 0) {
            passwordMatch.style.display = 'none';
            return;
        }

        passwordMatch.style.display = 'block';

        if (password1 === password2) {
            passwordMatch.className = 'mt-2 text-success fw-semibold small';
            passwordMatch.innerHTML = '<i class="fas fa-check-circle me-1"></i>Passwords match!';
            password2Field.classList.remove('is-invalid');
            password2Field.classList.add('is-valid');
        } else {
            passwordMatch.className = 'mt-2 text-danger fw-semibold small';
            passwordMatch.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Passwords do not match';
            password2Field.classList.remove('is-valid');
            password2Field.classList.add('is-invalid');
        }
    }

    // Event listeners
    password1Field.addEventListener('input', updatePasswordStrength);
    password1Field.addEventListener('input', checkPasswordMatch);
    password2Field.addEventListener('input', checkPasswordMatch);

    // Toggle password visibility
    togglePassword1.addEventListener('click', function() {
        const type = password1Field.type === 'password' ? 'text' : 'password';
        password1Field.type = type;
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    togglePassword2.addEventListener('click', function() {
        const type = password2Field.type === 'password' ? 'text' : 'password';
        password2Field.type = type;
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        const password1 = password1Field.value;
        const password2 = password2Field.value;

        // Validate password strength
        const { strength } = calculatePasswordStrength(password1);
        if (strength < 50) {
            e.preventDefault();
            password1Field.focus();
            alert('Please choose a stronger password. It should meet at least the basic requirements.');
            return;
        }

        // Validate password match
        if (password1 !== password2) {
            e.preventDefault();
            password2Field.focus();
            return;
        }

        // Loading state
        submitBtn.innerHTML = '<span class="position-relative z-index-1"><i class="fas fa-spinner fa-spin me-2"></i>Updating password...</span>';
        submitBtn.disabled = true;
        submitBtn.style.transform = 'scale(0.98)';

        // Animate button overlay
        btnOverlay.style.transform = 'scaleX(1)';
        btnOverlay.style.transition = 'transform 2s ease-out';
    });

    // Focus effects
    [password1Field, password2Field].forEach(field => {
        field.addEventListener('focus', function() {
            this.closest('.input-group').style.boxShadow = '0 0 0 0.2rem rgba(16, 185, 129, 0.25)';
            this.closest('.input-group').style.borderColor = '#10b981';
        });

        field.addEventListener('blur', function() {
            this.closest('.input-group').style.boxShadow = '';
            this.closest('.input-group').style.borderColor = '#dee2e6';
        });
    });

    // Button hover effects
    submitBtn.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 10px 25px rgba(16, 185, 129, 0.3)';
    });

    submitBtn.addEventListener('mouseleave', function() {
        if (!this.disabled) {
            this.style.transform = '';
            this.style.boxShadow = '';
        }
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-20px) rotate(1deg); }
    66% { transform: translateY(10px) rotate(-1deg); }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bg-gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.btn-gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-gradient-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
}

.is-valid {
    border-color: #10b981 !important;
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25) !important;
}

.is-invalid {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25) !important;
}

.input-group-text {
    border: 1px solid #dee2e6;
    border-right: none;
}

.form-control:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
}

.card {
    border: none;
    border-radius: 25px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
}

.z-index-1 {
    z-index: 1;
}

.progress {
}
</style>
{% endblock %}
