{% extends 'base.html' %}
{% load static %}

{% block title %}Medicine Inventory - HealthKart 360{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-boxes me-2"></i>Medicine Inventory</h2>
                <a href="{% url 'medicines:add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Medicine
                </a>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-number">{{ medicines.count }}</div>
                                <div class="stat-label">Total Medicines</div>
                            </div>
                            <i class="fas fa-pills fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-number">{{ in_stock_count }}</div>
                                <div class="stat-label">In Stock</div>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-75 text-success"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-number">{{ low_stock_count }}</div>
                                <div class="stat-label">Low Stock</div>
                            </div>
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75 text-warning"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stat-number">{{ out_of_stock_count }}</div>
                                <div class="stat-label">Out of Stock</div>
                            </div>
                            <i class="fas fa-times-circle fa-2x opacity-75 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search medicines...">
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="typeFilter" class="form-select">
                                <option value="">All Types</option>
                                <option value="tablet">Tablet</option>
                                <option value="capsule">Capsule</option>
                                <option value="syrup">Syrup</option>
                                <option value="injection">Injection</option>
                                <option value="cream">Cream</option>
                                <option value="drops">Drops</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="exportBtn" class="btn btn-outline-success w-100">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Medicine List</h5>
                </div>
                <div class="card-body">
                    {% if medicines %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="inventoryTable">
                                <thead>
                                    <tr>
                                        <th>Medicine Name</th>
                                        <th>Brand</th>
                                        <th>Type</th>
                                        <th>Strength</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Status</th>
                                        <th>Expiry</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for medicine in medicines %}
                                    <tr data-status="{{ medicine.stock_status }}" data-type="{{ medicine.medicine_type }}" data-medicine-id="{{ medicine.id }}">
                                        <td>
                                            <strong>{{ medicine.name }}</strong>
                                            <br><small class="text-muted">{{ medicine.generic_name }}</small>
                                        </td>
                                        <td>{{ medicine.brand }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ medicine.get_medicine_type_display }}</span>
                                        </td>
                                        <td>{{ medicine.strength }}</td>
                                        <td>â‚¹{{ medicine.price }}</td>
                                        <td>
                                            <span class="fw-bold {% if medicine.quantity == 0 %}text-danger{% elif medicine.quantity < 10 %}text-warning{% else %}text-success{% endif %}">
                                                {{ medicine.quantity }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if medicine.stock_status == 'in_stock' %}bg-success{% elif medicine.stock_status == 'low_stock' %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ medicine.status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="{% if medicine.expiry_date <= today %}text-danger{% elif medicine.expiry_date <= warning_date %}text-warning{% endif %}">
                                                {{ medicine.expiry_date|date:"M d, Y" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="updateStock({{ medicine.id }}, '{{ medicine.name }}', {{ medicine.quantity }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <a href="{% url 'medicines:edit' medicine.id %}" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-cog"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteMedicine({{ medicine.id }}, '{{ medicine.name }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No medicines in inventory</h4>
                            <p class="text-muted">Start by adding your first medicine to the inventory.</p>
                            <a href="{% url 'medicines:add' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Medicine
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Update Modal -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <div class="mb-3">
                        <label class="form-label">Medicine Name</label>
                        <input type="text" id="medicineName" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newQuantity" class="form-label">New Quantity</label>
                        <input type="number" id="newQuantity" class="form-control" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStockUpdate()">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMedicineId = null;

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#inventoryTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Filter functionality
document.getElementById('statusFilter').addEventListener('change', filterTable);
document.getElementById('typeFilter').addEventListener('change', filterTable);

function filterTable() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('#inventoryTable tbody tr');
    
    rows.forEach(row => {
        const status = row.dataset.status;
        const type = row.dataset.type;
        const statusMatch = !statusFilter || status === statusFilter;
        const typeMatch = !typeFilter || type === typeFilter;
        
        row.style.display = statusMatch && typeMatch ? '' : 'none';
    });
}

// Stock update functionality
function updateStock(medicineId, medicineName, currentQuantity) {
    currentMedicineId = medicineId;
    document.getElementById('medicineName').value = medicineName;
    document.getElementById('newQuantity').value = currentQuantity;
    new bootstrap.Modal(document.getElementById('stockModal')).show();
}

function saveStockUpdate() {
    const newQuantity = document.getElementById('newQuantity').value;
    
    if (!newQuantity || newQuantity < 0) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    fetch(`/medicines/${currentMedicineId}/update-stock/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({quantity: newQuantity})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update stock.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update stock.');
    });
}

// Delete medicine functionality
function deleteMedicine(medicineId, medicineName) {
    if (confirm(`Are you sure you want to delete "${medicineName}"? This action cannot be undone.`)) {
        fetch(`/medicines/${medicineId}/delete-ajax/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Remove the row from the table
                const row = document.querySelector(`tr[data-medicine-id="${medicineId}"]`);
                if (row) {
                    row.remove();
                } else {
                    location.reload();
                }
            } else {
                showToast(data.message || 'Failed to delete medicine.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to delete medicine.', 'danger');
        });
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Export functionality
document.getElementById('exportBtn').addEventListener('click', function() {
    // Simple CSV export
    const table = document.getElementById('inventoryTable');
    const rows = table.querySelectorAll('tbody tr');
    let csv = 'Medicine Name,Brand,Type,Strength,Price,Stock,Status,Expiry\n';
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const cells = row.querySelectorAll('td');
            const rowData = [];
            cells.forEach((cell, index) => {
                if (index < 8) { // Exclude actions column
                    rowData.push(`"${cell.textContent.trim()}"`);
                }
            });
            csv += rowData.join(',') + '\n';
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory.csv';
    a.click();
    window.URL.revokeObjectURL(url);
});
</script>
{% endblock %} 